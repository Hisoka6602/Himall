@using Himall.Core
@{
    ViewBag.Title = "订单提交";
    var model = (Himall.DTO.OrderPreproResult)ViewBag.ConfirmModel;
    var param = (Himall.DTO.OrderPreproCommand)ViewBag.OrderParam;
    var products = model.SubOrders[0].Items;
    //var products = (IEnumerable<Himall.DTO.MobileShopCartItemModel>)ViewBag.ConfirmModel.products;
    var canIntegralPerMoney = (bool?)ViewBag.CanIntegralPerMoney;
    var canCapital = (bool)ViewBag.CanCapital;
    var productType = param.IsVirtual ? 1 : 0;
    var shipperAddress = model.PickupAddress == null ? "" : model.PickupAddress.Address;
    var shipperTelPhone = model.PickupAddress == null ? "" : model.PickupAddress.Contact;
    Himall.DTO.Market.GeneralRecord OneCoupons = null;
    if (model.Records != null)
    {
        OneCoupons = model.Records.FirstOrDefault(r => r.Selected == true && r.RecordType == Himall.DTO.Market.GeneralRecordType.Platform);
    }
    var invoiceTitles = (List<Himall.Entities.InvoiceTitleInfo>)ViewBag.InvoiceTitles;
    var vatInvoice = (Himall.Entities.InvoiceTitleInfo)ViewBag.vatInvoice;
    var cellPhone = (string)ViewBag.cellPhone;
    var email = (string)ViewBag.email;
    var invoiceName = (string)ViewBag.invoiceName;
    var invoiceCode = (string)ViewBag.invoiceCode;
    var zyShop = model.SubOrders.Where(p => p.ShopId == 1).FirstOrDefault();
    var otherShops = model.SubOrders.Where(p => p.ShopId != 1).ToList();
}

<input id="icod" type="hidden" value="@(zyShop==null?"false":(zyShop.IsCashOnDelivery?"true":"false"))" />
<input id="total" type="hidden" value="@(model.Amount)" />
<input id="producttotal" type="hidden" value="@(model.SubOrders.Sum(o=>o.Items.Sum(i=>i.Price*i.Quantity)))" />
<input id="platcoupontotal" type="hidden" value="@(OneCoupons==null?0:OneCoupons.ActualAmount)" />
<input id="collocationId" type="hidden" value="@param.CollocationId" />
<input id="shopBranchId" type="hidden" value="@param.ShopBranchId" />
<input id="flashSaleId" type="hidden" value="@param.FlashSaleId" />
<input id="cartItems" type="hidden" value="@(ViewBag.CartItems)" />
<input id="choiceCoupons" type="hidden" value="@(Newtonsoft.Json.JsonConvert.SerializeObject(param.Records))" />

<link href="~/Areas/Mobile/Templates/Default/Content/shopbranchs.css?v=20183030" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="~/Areas/Mobile/Templates/Default/Content/mui.min.css" />
<link rel="stylesheet" type="text/css" href="~/Areas/Mobile/Templates/Default/Content/mui.picker.css" />
<link rel="stylesheet" type="text/css" href="~/Areas/Mobile/Templates/Default/Content/mui.poppicker.css" />
<style>
    body { height: 100vh; overflow: auto; }
</style>
<div class="container submit-cart store-submit">
    @{
        var defaultAddress = model.Address;
        var shopBranchInfo = model.SubOrders[0].ShopBranchAttach;
        var shopBranchId = model.SubOrders[0].ShopBranchId;
        var shopBranchName = model.SubOrders[0].ShopBranchName;
        var isPickup = model.SubOrders[0].IsPickup;
        var isStoreDelive = model.SubOrders[0].IsStoreDelive;
        var shop = model.SubOrders[0];
        Himall.DTO.Market.GeneralRecord defaultCoupons = null;
        if (shop.Records != null && shop.Records.Count > 0)
        {
            defaultCoupons = shop.Records.FirstOrDefault(r => r.Selected);
        }
    }
    @if (productType == 0)
    {
        if (defaultAddress != null)
        {
            var addDetail = defaultAddress.AddressDetail ?? "";
            <a class="street-well" id="choiceAddr" href="/@(ViewBag.AreaName)/BranchOrder/ChooseShippingAddress?isOrder=1&addId=@defaultAddress.Id&shopBranchId=@shopBranchId&returnUrl=@HttpUtility.UrlEncode(Request.RawUrl)">
                <p>@defaultAddress.ShipTo, @defaultAddress.Phone</p>
                <span>@defaultAddress.RegionFullName &nbsp;@defaultAddress.Address&nbsp;@addDetail</span>
                <i class="glyphicon glyphicon-menu-right"></i>
            </a>
        }
        else
        {
            <a class="street-well" id="choiceAddr" href="/@(ViewBag.AreaName)/BranchOrder/ChooseShippingAddress?isorder=1&shopBranchId=@shopBranchId&returnUrl=@HttpUtility.UrlEncode(Request.RawUrl)">
                <p>请选择收货地址</p>
                <span style="color:red;padding: 0;">您没有收货地址或已有地址不在服务范围内</span>
            </a>
        }
    }


    <div class="item mb11">
        @if (productType == 0)
        {
            <div class="detail-anchor divider">
                <span>配送方式</span>
                @if (isPickup)
                {
                    <label class="divider-btn @(isStoreDelive ? "" : "active")" deliverytype="@((int)Himall.CommonModel.DeliveryType.SelfTake)">到店自提</label>
                }
                @if (isStoreDelive)
                {
                    <label class="divider-btn active" deliverytype="@((int)Himall.CommonModel.DeliveryType.ShopStore)">门店配送</label>
                }
            </div>
            <div class="addr-detail hide" id="divshopbranchInfo" shopbranchid="@shop.ShopBranchId">
                <h4>@shopBranchName, @shopBranchInfo.Contact</h4>
                <p>@(shopBranchInfo.Address) </p>
                <h4 class="mt8">营业时间: @(shopBranchInfo.OpenTime +"-"+ @shopBranchInfo.CloseTime)</h4>
            </div>
        }
    </div>

    <div class="goods-info mb10" id="@shop.ShopId" shopid="@shop.ShopId" shopbranchid="@shop.ShopBranchId">
        <div class="item">
            <div class="goods-shop">
                <i class="ic_store"></i>
                @shop.ShopBranchName
            </div>
        </div>
        @foreach (var product in shop.Items)
        {
            <div class="item" pid="@product.ProductId" skuid="@product.SkuId" count="@product.Quantity" price="@product.Amount">
                <div class="buy-goods">
                    <img src="@product.Thumbnail">
                    <h6><span><a href="/@(ViewBag.AreaName)/Branchproduct/detail/@product.ProductId?shopBranchId=@shop.ShopBranchId">@product.Name</a></span><em>¥ @product.Price.ToString("F2")</em></h6>
                    <h5>
                        <p class="gray">
                            @if (!string.IsNullOrEmpty(product.Size))
                            {
                                <label>@product.SizeAlias：@(MvcHtmlString.Create(product.Size)) &nbsp;&nbsp;</label>
                            }
                            @if (!string.IsNullOrEmpty(product.Color))
                            {
                                <label>@product.ColorAlias：@(MvcHtmlString.Create(product.Color)) &nbsp;&nbsp;</label>
                            }
                            @if (!string.IsNullOrEmpty(product.Version))
                            {
                                <label>@product.VersionAlias：@(MvcHtmlString.Create(product.Version))</label>
                            }
                        </p>
                        <p class="gray text-right">x @product.Quantity</p>
                    </h5>
                </div>
            </div>
        }
        <div id="payment_m" class="payment_m">
            <span style="font-size: 16px;color: #212121;">支付方式</span>
            <span class="payment-c"><a href="javascript:void(0)">在线支付 </a></span>
        </div>


    </div>
    @if (productType == 1 && !string.IsNullOrWhiteSpace(shipperAddress) && !string.IsNullOrWhiteSpace(shipperTelPhone))
    {
        <div class="goods-info mb10">
            <div class="item">
                <div class="detail-anchor">联系电话<span class="pull-right">@shipperTelPhone</span></div>
            </div>
            <div class="item">
                <div class="detail-anchor" style="height: auto;padding: 10px 0;line-height: 22px;display: flex;justify-content: space-between;">
                    <span style="flex-shrink:0; margin-left:10px;">核销地址</span>
                    <span style="flex-shrink: 1;width:100%;text-align:right;margin: 0 10px;">@shipperAddress</span>
                </div>
            </div>
        </div>
    }
    @if (productType == 0)
    {
        <div class="bill btnbill h47 @(shop.IsInvoice ? "" : "hide")" data-shopid="@shop.ShopId">
            <span>发票信息</span>
            <i class="glyphicon glyphicon-menu-right"></i>
            <span class="bill-detail">
                <a href="javascript:void(0)" class="bill-title@(shop.ShopId)">不需要发票</a>
                <input type="hidden" id="invoicecode" />
            </span>
        </div>
    }



    <!--留言字段添加6-12-->
    <div class="item">
        <div class="leave-message h47">
            <label>留言</label>
            <div class="leave-message-inner" style="left:75px"><input type="text" class="orderRemarks" id="remark_@shop.ShopId" placeholder="选填,可填写您和卖家达成一致的要求"></div>
        </div>
    </div>

    <div class="item bottom-info mb11">

        <div class="detail-anchor">
            商品金额<span class="pull-right rtext" id="proAmount" data-nfprice="@(model.Amount-model.SubOrders.Sum(o=>o.Freight))" data-price="@(model.Amount)">¥@(model.SubOrders.Sum(r=>r.Items.Sum(i=>i.Quantity*i.Price)).ToString("F2"))</span></div>

        @if (shop.FullDiscount > 0)
        {
            <div class="detail-anchor">满额优惠<span class="pull-right rtext">-¥@shop.FullDiscount</span></div>
        }
        @if (shop.Records != null && shop.Records.Count() > 0)
        {
            defaultCoupons = shop.Records.FirstOrDefault(r => r.Selected);
            <div class="item choseCoupon">
                <div class="detail-anchor divider">
                    <label class="ml0">选择优惠券</label>
                    <i class="glyphicon glyphicon-menu-right" style="float:right;line-height:43px"></i>
                    <label class="content fr">@(defaultCoupons == null ? "不使用优惠券" : " - ¥" + defaultCoupons.Amount)</label>
                </div>
                <div class='dialog dialogCoupon'>
                    <div class='dialog-title'>
                        <div class='text'>选择优惠券</div>
                        <i class='dialog-close'></i>
                    </div>
                    <div class='dialog-content'>
                        <ul class='coupon-chooselist'>
                            <li class='coupon-item' onclick="onChooseCoupon(0,99, this,@shop.ShopId)">
                                <input type="radio" name="coupon" @(defaultCoupons == null ? "checked" : "") />
                                <p>不使用优惠券</p>
                            </li>
                            @foreach (var coupon in shop.Records)
                            {

                                <li class='coupon-item' onclick="onChooseCoupon(@(coupon.Id),@((int)coupon.RecordType), this,@shop.ShopId)">
                                    <input type="radio" name="coupon" @((defaultCoupons != null && defaultCoupons.Id == coupon.Id) ? "checked" : "") />
                                    <div class='detail'>
                                        <p class='couponprice'>￥ @(coupon.Amount)</p>
                                        <p class='rule'>满@(coupon.OrderAmount)元可用（不含运费）</p>
                                    </div>
                                    <div class='desc'>
                                        <p>@(coupon.IsLimit == false ? "全场通用" : "部分商品可用")</p>
                                        <p>@(coupon.StartText)-@(coupon.EndText)</p>
                                    </div>
                                </li>

                            }
                        </ul>
                        @if (defaultCoupons != null)
                        {
                            <input type="hidden" data-type="@((int)defaultCoupons.RecordType)" data-shopid="@shop.ShopId" name="couponIds" value="@defaultCoupons.Id" />
                        }
                        else
                        {
                            <input type="hidden" data-type="99" name="couponIds" value="0" data-shopid="@shop.ShopId" />
                        }
                    </div>
                </div>
            </div>
        }
        @if (productType == 0)
        {
            var total = shop.Items.Sum(item => item.Price * item.Quantity) - shop.FullDiscount - (defaultCoupons == null ? 0 : defaultCoupons.ActualAmount);
            if (total < 0)
            { total = 0; }

            if (!shop.FreeFreight)
            {
                <div class="detail-anchor" id="divDeliveFee" data-fee="@shop.Freight">配送费<span class="pull-right rtext">¥@shop.Freight</span></div>
            }
            if (shop.FreeFreight)
            {
                <div class="detail-anchor" id="divDeliveFee" data-fee="0">配送费<span class="pull-right rtext">满额免运费</span></div>
            }
        }
    </div>
    @*平台优惠券 Begin*@
    @if (model.Records != null && model.Records.Count() > 0)
    {
        var totalAmount = model.Amount + (OneCoupons == null ? 0 : OneCoupons.ActualAmount) - model.SubOrders.Sum(o => (o.FreeFreight ? 0 : o.FreeFreightAmount));
        <div class="goods-info mb11">
            <div class="item choseCoupon">
                <div class="detail-anchor divider">
                    <label class="ml0">平台优惠券</label>
                    <i class="glyphicon glyphicon-menu-right" style="float:right;line-height:43px"></i>
                    <label class="content fr">@(OneCoupons == null || totalAmount <= 0 ? "不使用平台优惠券" : " - ¥" + OneCoupons.ActualAmount)</label>
                </div>
                <div class='dialog dialogCoupon'>
                    <div class='dialog-title'>
                        <div class='text'>平台优惠券</div>
                        <i class='dialog-close'></i>
                    </div>
                    <div class='dialog-content'>
                        <ul class='coupon-chooselist'>
                            <li class='coupon-item' onclick="onChoosePlatCoupon(0,99, this,0)">
                                <input type="radio" name="coupon" @(OneCoupons == null || totalAmount <= 0 ? "checked" : "") />
                                <p>不使用平台优惠券</p>
                            </li>
                            @foreach (var coupon in model.Records)
                            {

                                <li class='coupon-item' onclick="onChoosePlatCoupon(@(coupon.Id),@((int)coupon.RecordType), this,0)">
                                    <input type="radio" name="coupon" @((OneCoupons != null && totalAmount > 0 && OneCoupons.Id == coupon.Id) ? "checked" : "") />
                                    <div class='detail'>
                                        <p class='couponprice'>￥ @(coupon.Amount)</p>
                                        <p class='rule'>满@(coupon.OrderAmount)元可用（不含运费）</p>
                                    </div>
                                    <div class='desc'>
                                        <p>@(coupon.IsLimit == false ? "全场通用" : "部分商品可用")</p>
                                        <p>@(coupon.StartText)-@(coupon.EndText)</p>
                                    </div>
                                </li>
                            }
                        </ul>
                        @if (OneCoupons != null && totalAmount > 0)
                        {
                            <input type="hidden" data-type="@((int)OneCoupons.RecordType)" data-shopid="0" name="platCouponIds" value="@((int)OneCoupons.Id)" />
                            <input type="hidden" data-type="99" id="platCouponIds" value="@((decimal)OneCoupons.ActualAmount)" data-shopid="0" />
                        }
                        else
                        {
                            <input type="hidden" data-type="99" name="platCouponIds" value="0" data-shopid="0" />
                            <input type="hidden" data-type="99" id="platCouponIds" value="0" data-shopid="0" />
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    @*平台优惠券 End*@

    @if (canIntegralPerMoney == true && param.GroupId <= 0 && param.GrouponId <= 0 && model.IntegralPerMoney > 0 && model.Integral > 0)
    {
        <div class="goods-info mb11">
                <div class="item">
                    <div class="detail-anchor" style="overflow:hidden;">
                        <input type="hidden" id="userIntegrals" value="@(model.Integral)" />
                        <span class="pull-left score">可用积分抵扣<label><em>￥@(model.IntegralMaxMoney> (model.Integral/ model.IntegralPerMoney) ? (Math.Floor(model.Integral*1.0M / model.IntegralPerMoney*100)/100.0M) : model.IntegralMaxMoney)</em></label></span>
                        <span class="pull-right">
                            <label class="custom-switch">
                                <input type="checkbox" class="hidden" id="userIntegralSwitch" />
                                <div class="switch-inner"><div class="switch-handle"></div></div>
                            </label>
                        </span>
                    </div>
                </div>
                <div class="item" id="integralContainer" style="display:none;height:36px;line-height:36px;">
                    <div class="detail-anchor">
                        <span class="pull-left score">
                            使用积分:<input type="number" class="text-center quantity-text" style="height: 22px; margin-left: 30px; border: none; margin-bottom: 0px; text-align: left;"
                                        onkeyup="(this.v=function(){this.value = this.value.replace(/[^\d]/g,'');}).call(this);" name="useintegral" id="useintegral" value="@(Math.Ceiling(model.IntegralMaxMoney*model.IntegralPerMoney))" data-maxmoney="@(model.IntegralMaxMoney)" data-rate="@(model.IntegralPerMoney)" />
                        </span>
                        <span class="pull-right score"><em id="integralPrice"></em></span>
                    </div>
                </div>
        </div>

        }
        <div class="goods-info mb11" id="divInvoiceAmount" style="display:none;">
            <div class="item">
                <div class="detail-anchor">税费<span class="pull-right" id="invoiceAmount" data-amount="0.00">￥0.00 </span></div>
            </div>
        </div>
        @if (canCapital && model.CapitalAmount > 0)
        {
            <div class="goods-info mb11">
                <div class="item">
                    <div class="detail-anchor" style="overflow:hidden;">
                        <input type="hidden" id="userCapitals" value="0" />
                        <span class="pull-left score">余额支付<label>共 ￥@(model.CapitalAmount) 可用<em></em></label></span>
                        <span class="pull-right">
                            <label class="custom-switch">
                                <input type="checkbox" class="hidden" id="userCapitalSwitch" />
                                <div class="switch-inner"><div class="switch-handle"></div></div>
                            </label>
                        </span>
                    </div>
                </div>
                <div class="item" id="capitalContainer" style="display:none;height:36px;line-height:36px;">
                    <div class="detail-anchor">
                        <span class="pull-left score">
                            使用余额:<input type="text" class="text-center quantity-text" style="height: 22px; margin-left: 30px; border: none; text-align: left; margin-bottom: 0px;
" name="capital" id="capital" value="@(model.CapitalAmount)" data-balance="@(model.CapitalAmount)" />
                        </span>
                        <span class="pull-right score"><em id="capitalPrice"></em></span>
                    </div>
                </div>
            </div>
        }
        @if (productType == 0)
        {
            <div class="bill-Cart" name="divInvoice@(shop.ShopId)">
                <div class="bill-C00">
                    <div class="form invoice" id="dvInvoice" name="formInvoice@(shop.ShopId)">
                        <div class='single-info pb0'>
                            <h3 class='title'>发票类型 <a class="noInvoice" style="float:right;font-size:12px;color:blue;font-weight:500;" data-shopid="@shop.ShopId">不需要发票</a></h3>
                            <div class='btns dvInvoiceType'>
                                <span data-id="0" data-rate="0" data-shopid="@shop.ShopId" style="display:none;">不需要发票</span>
                                @if (shop.IsInvoice)
                                {

                                    if (shop.Invoice.IsPlainInvoice)
                                    {
                                        <span class="@(shop.Invoice.IsPlainInvoice?"active":"")" data-id="@Himall.CommonModel.InvoiceType.OrdinaryInvoices.GetHashCode()" data-rate="@shop.Invoice.PlainInvoiceRate" data-shopid="@shop.ShopId">@Himall.CommonModel.InvoiceType.OrdinaryInvoices.ToDescription()</span>
                                    }
                                    if (shop.Invoice.IsElectronicInvoice)
                                    {
                                        <span class="@(!shop.Invoice.IsPlainInvoice?"active":"")" data-id="@Himall.CommonModel.InvoiceType.ElectronicInvoice.GetHashCode()" data-rate="@shop.Invoice.PlainInvoiceRate" data-shopid="@shop.ShopId">@Himall.CommonModel.InvoiceType.ElectronicInvoice.ToDescription()</span>
                                    }
                                    if (shop.Invoice.IsVatInvoice)
                                    {
                                        <span class="@(!shop.Invoice.IsPlainInvoice&&!shop.Invoice.IsElectronicInvoice?"active":"")" data-id="@Himall.CommonModel.InvoiceType.VATInvoice.GetHashCode()" data-rate="@shop.Invoice.VatInvoiceRate" data-shopid="@shop.ShopId">@Himall.CommonModel.InvoiceType.VATInvoice.ToDescription()</span>
                                    }

                                }
                            </div>
                            <div class="invoice-vat-title invoiceDay" style="display:none;">
                                发票将在订单完成之后@(shop.IsInvoice?shop.Invoice.VatInvoiceDay:"0")个工作日后寄出
                            </div>
                        </div>
                        <div class='single-info dvInvoiceTitle pb0'>
                            <h3 class='title'>发票抬头</h3>
                            <div class='btns dvInvoiceRise'>
                                <span class="@((string.IsNullOrEmpty(invoiceName) || string.IsNullOrEmpty(invoiceCode))?"active":"")" data-id="0">个人</span>
                                <span class="@((!string.IsNullOrEmpty(invoiceName) && !string.IsNullOrEmpty(invoiceCode))?"active":"")" data-id="1">公司</span>
                            </div>
                            <div class="dvInvoincPepole" style="@((string.IsNullOrEmpty(invoiceName) || string.IsNullOrEmpty(invoiceCode))?"":"display:none;")">
                                <input type="text" id="invoicepepole" name="invoicepepole" placeholder="请输入个人抬头" />
                            </div>
                            <div class="dvInvoincCompany" style="@((!string.IsNullOrEmpty(invoiceName) && !string.IsNullOrEmpty(invoiceCode))?"":"display:none;")">
                                <div class="company">
                                    <input type="text" name="invoicename" placeholder="请输入公司名称" value="@(invoiceName)" />
                                    <ul class="companylist">
                                        @foreach (var i in invoiceTitles)
                                        {
                                            <li><a style="display: list-item;" data-code="@i.Code">@i.Name</a><i class="iconfonts icon-icon__trash del-title" data-id="@i.Id"></i></li>
                                        }
                                    </ul>
                                </div>
                                <input type="text" name="invoicecode" placeholder="请输入公司纳税人识别号, 必填" value="@(invoiceCode)" />
                            </div>
                        </div>
                        <div class='single-info pb0'>
                            <h3 class='title'>发票内容</h3>
                            <div class='btns dvInvoiceContext'>
                                @{ var inde = 0;}
                                @if (model.InvoiceContext != null)
                                {
                                    foreach (var item in model.InvoiceContext)
                                    {
                                        <span class="invoicecontext @(inde == 0 ? "active" : "")">@item</span>
                                        inde++;
                                    }
                                }
                            </div>
                        </div>
                        <div class="single-info edit-con pb0 elInvoice" style="display:none;">
                            <h3 class='title'>收票人信息</h3>
                            <div class="line">
                                <label>收票人手机</label>
                                <input type="text" name="cellphone" placeholder="请输入手机号码, 必填" value="@(cellPhone)" />
                            </div>
                            <div class="line">
                                <label>收票人邮箱</label>
                                <input type="text" name="email" placeholder="收票人邮箱, 必填" value="@(email)" />
                            </div>
                        </div>
                        @if (vatInvoice != null)
                        {
                            <div class="vatInvoice" style="display:none;">
                                <div class='single-info pb0 edit-con'>
                                    <h3 class='title'>增票资质</h3>
                                    <div class="line">
                                        <label>单位名称</label>
                                        <input type="text" name="companyname" placeholder="请填写单位名称, 必填" value="@(vatInvoice.Name)" />
                                    </div>
                                    <div class="line">
                                        <label>纳税人识别号</label>
                                        <input type="text" name="companyno" placeholder="请填写纳税人识别号, 必填" value="@(vatInvoice.Code)" />
                                    </div>
                                    <div class="line">
                                        <label>注册地址</label>
                                        <input type="text" name="registeraddress" placeholder="请填写公司注册地址, 必填" value="@(vatInvoice.RegisterAddress)" />
                                    </div>
                                    <div class="line">
                                        <label>注册电话</label>
                                        <input type="text" name="registerphone" placeholder="请填写公司注册电话, 必填" value="@(vatInvoice.RegisterPhone)" />
                                    </div>
                                    <div class="line">
                                        <label>开户银行</label>
                                        <input type="text" name="bankname" placeholder="请填写公司开户银行, 必填" value="@(vatInvoice.BankName)" />
                                    </div>
                                    <div class="line">
                                        <label>银行账户</label>
                                        <input type="text" name="bankno" placeholder="请填写开户银行账号, 必填" value="@(vatInvoice.BankNo)" />
                                    </div>
                                </div>
                                <div class='single-info pb0 edit-con'>
                                    <h3 class='title'>收票人信息</h3>
                                    <div class="line">
                                        <label>收票人姓名</label>
                                        <input type="text" name="vatrealname" placeholder="请填写真实姓名, 必填" value="@(vatInvoice.RealName)" />
                                    </div>
                                    <div class="line">
                                        <label>收票人手机</label>
                                        <input type="text" name="vatcellphone" placeholder="请输入手机号码, 必填" value="@(vatInvoice.CellPhone)" />
                                    </div>
                                    <div class="line">
                                        <label>收票人地区</label>
                                        <input type="text" name="showCity" readonly="readonly" placeholder="省/市/区(县)" value="@(vatInvoice.RegionFullName)" />
                                        <input type="hidden" name="RegionID" value="@(vatInvoice.RegionID)" />
                                    </div>
                                    <div class="line">
                                        <label>详细地址</label>
                                        <input type="text" name="vataddress" placeholder="请输入详细地址, 必填" value="@(vatInvoice.Address)" />
                                    </div>
                                </div>
                            </div>

                        }
                    </div>
                    <a class="bill-submit clearfix" data-shopid="@shop.ShopId">
                        确定
                    </a>
                </div>
            </div>
        }
        <div class="custom-dialog" id="paymentsChooser"></div>
        <!--支付方式弹框页-->
        <div class="payment-way">
            @if (zyShop != null && zyShop.Items.Count > 0)
            {
                <div class="way-01">
                    <h3>
                        @if (productType == 0)
                        {
                            <span>支持在线支付和货到付款</span>
                        }
                        else
                        {
                            <span>支持在线支付</span>
                        }<em>共<span id="unpay_pro_t">@zyShop.Items.Count</span>件</em>
                    </h3>
                    <div class="pro-mid">
                        <div class="pro-list">
                            <div class="pro-wrap">
                                <div class="pro-img">
                                    <ul>
                                        @foreach (var product in zyShop.Items)
                                        {
                                            <li><a><img src="@product.Thumbnail"></a></li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="way-detail">
                            <a class="online active">在线支付</a>
                            @if (zyShop != null && (bool)zyShop.IsCashOnDelivery && zyShop.Items.Count > 0 && productType == 0)
                            {
                                <a class="offline">货到付款</a>
                            }

                        </div>
                    </div>
                </div>}

            @if (otherShops != null && otherShops.Count > 0)
            {
                <div class="way-02">
                    <h3>
                        <span>仅支持在线支付</span><em>共<span id="unpay_pro_t">@otherShops.Sum(p => p.Items.Count)</span>件</em>
                    </h3>
                    <div class="pro-mid">
                        <div class="pro-list">
                            <div class="pro-wrap">
                                <div class="pro-img">
                                    <ul>
                                        @foreach (var oshop in otherShops)
                                        {
                                            foreach (var product in oshop.Items)
                                            {
                                                <li><a><img src="@product.Thumbnail"></a></li>
                                            }
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="way-detail">
                            <a class="online active">在线支付</a>
                        </div>
                    </div>
                </div>}
            <a id="pay-submit">
                确定
            </a>
        </div>
    </div>
    <div class="cover" style="display:none;"></div>

    <script>
    var isLimitTimeBuy = "@ViewBag.IsLimit";
    var isFightGroup = @(((bool?)ViewBag.IsFightGroup)==true?"true":"false");
    var hasVerifiedPayPwd=false;
    </script>
    <input type="hidden" id="latAndLng" value="@(defaultAddress != null ? defaultAddress.Latitude+","+defaultAddress.Longitude:"0,0")" />
    <input type="hidden" id="shippingAddressId" value="@(defaultAddress != null ? defaultAddress.Id.ToString() : "")" />
    <input type="hidden" id="shippingAddressRegionId" value="@(defaultAddress != null ? defaultAddress.RegionId.ToString() : "")" />
    <input type="hidden" id="integralPerMoney" value="@(model.IntegralMaxMoney)" />
    <input type="hidden" id="capitalAmount" value="@(model.CapitalAmount)" />
    <input type="hidden" id="collPIds" value="@(string.Join(",",param.Items.Select(p=>p.ProductId)))">
    <input type="hidden" id="groupActionId" value="@(param.GrouponId)">
    <input type="hidden" id="groupId" value="@(param.GroupId)">
    <input type="hidden" id="productType" value="@(param.IsVirtual?1:0)">
    <input type="hidden" id="PayCapitalPwd" value="" />



    <footer class="clearfix footer-cart">
        <em class="cart-total cart-total-lg">
            总金额<a id="allTotal" data-alltotal="@(model.Amount)">¥@(model.Amount.ToString("f2"))</a><em class="price" data-price="@(model.Amount)"></em>
        </em>
        <a id="submit-order" class="cart-pay">提交</a>
    </footer>
    <script src="~/Areas/Mobile/Templates/Default/Scripts/mui.min.js"></script>
    <script src="~/Areas/Mobile/Templates/Default/Scripts/mui.picker.js"></script>
    <script src="~/Areas/Mobile/Templates/Default/Scripts/mui.poppicker.js"></script>
    <script src="~/Areas/Mobile/Templates/Default/Scripts/BranchSubmitOrder.js?v=20210427"></script>
    <script type="text/javascript">
    var existShopBranchUrl='@Url.Action("ExistShopBranch")';
    var isintegral = false;
    var iscapital = false;
    var isResetUseCapital=false;
    var choseShopBranch = {};
    $(function () {

        $("input[type='text']").attr("autocomplete", "new-password");
        $("input[type='number']").attr("autocomplete", "new-password");

        $('.choseCoupon').click(function () {
            $('.dialogCoupon', this).addClass('active').show();
            $('.cover').fadeIn();
        });

        $('.dialog-close').click(function (e) {
            e.stopPropagation();
            $('.dialogCoupon.active').hide();
            $('.cover').fadeOut();
        });
        //<!--商品滑动-->
        $(".pro-list .pro-img").each(function () {
            $(this).width($('li', this).length * 72);
        });
        //配送方式
        if ($(".divider .active").attr("deliverytype") == "2") {
            $("#choiceAddr").show();
            $("#divshopbranchInfo").addClass("hide");
            $("#divDeliveFee").show();
            var alltotal = parseFloat($("#allTotal").attr("data-alltotal"));
            $("#allTotal").html("¥" + (alltotal).toFixed(2));
        } else {
            $("#choiceAddr").hide();
            $("#divshopbranchInfo").removeClass("hide");
            $("#divDeliveFee").hide();
            var delivefee = parseFloat($("#divDeliveFee").attr("data-fee"));
            delivefee = isNaN(delivefee) ? 0 : delivefee;//当店铺只有到店自提时没有改控件，则判断默认值为0
            var alltotal = parseFloat($("#allTotal").attr("data-alltotal"));
            $("#allTotal").html("¥" + (alltotal - delivefee).toFixed(2));
        }
        $(".divider .divider-btn").each(function () {
            $(this).click(function () {
                if ($(this).hasClass("active")) {
                    return;
                }
                $(this).siblings(".divider-btn").removeClass("active");
                $(this).addClass("active");
                if ($(this).attr("deliverytype") == "2") {
                    $("#choiceAddr").show();
                    $("#divshopbranchInfo").addClass("hide");
                    $("#divDeliveFee").show();
                } else {
                    $("#choiceAddr").hide();
                    $("#divshopbranchInfo").removeClass("hide");
                    $("#divDeliveFee").hide();
                }
                CalcPrice();
            })
        })

        $("input[name$='DeliveryType'].express").change(function () {
            if (this.checked == false)
                return;

            var goodsInfo = $(this).closest('.goods-info');
            var shopId = goodsInfo.attr('shopid');
            var div = goodsInfo.find('.choseshopbranch');
            div.addClass('hide');

            var priceElement = goodsInfo.find('.item .price');
            var oldPrice = parseFloat(priceElement.data('oldprice'));
            priceElement.html('￥' + oldPrice.toFixed(2)).data('price', oldPrice);

            //运费
            var strFreight = "免运费";
            if (parseFloat(priceElement.data('freight')) > 0)
                strFreight = priceElement.data('freight') + "元";
            goodsInfo.find(".showfreight").html(strFreight);
            $('.goods-info#{0} .price'.format(shopId)).removeAttr('selftake');

            CalcPrice();
        }).each(function () { this.checked = true; });

        $("input[name$='DeliveryType'].selftake").change(function () {
            if (this.checked == false)
                return;

            var div = $(this).closest('.goods-info').find('.choseshopbranch');
            if ($('#shippingAddressId').val() == '') {
                $.dialog.errorTips('请先设置收货地址');
                $(this).parent().parent().find('input[name$=".DeliveryType"].express').get(0).checked = true;
                return;
            }
            div.removeClass('hide');

            var $this = $(this);
            if ($this.attr('sbid')) {
                var shopId = $this.closest('.goods-info').attr('shopid');
                freeFreight(shopId);
                $('.goods-info#{0} .price'.format(shopId)).attr('selftake', '');
            }
        });
        $('#capital').keyup(function () {
            var c = $(this);
            var oldVal = c.val();
            c.val(oldVal.replace(/[^\d|.]/, ''));
            c.val(c.val().replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3'));
        });

        var tagCacheKey = 'tagCacheKey';//标记，用于标记是否是从地址选择页或门店选择页返回到当前页的
        var sbCacheKey = 'ChoseShopBranch.Value';
        var saCacheKey = 'ChoseShippingAddress.Value';
        var $shippingAddressId = $('#shippingAddressId');
        var shippingAddressId = $shippingAddressId.val();
        var $shippingAddressRegionId = $('#shippingAddressRegionId');
        var shippingAddressRegionId = $shippingAddressRegionId.val();

        //首次进入提交订单页面清除上次选择门店，链接未带优惠券参数且页面来源不是选择门店即为初次进入
        if (!QueryString('couponids') && document.referrer.indexOf('order') == -1) {
            window.localStorage.removeItem(tagCacheKey);
        }

        var cacheValue = window.getFromLocalStorate(tagCacheKey);
        //如果标记值为空，表示是从商品等其它页面过来的
        if (cacheValue) {
            cacheValue = window.getFromLocalStorate(saCacheKey);
            if ($.notNullOrEmpty(cacheValue)) {
                if (cacheValue.isClear) {
                    $("#latAndLng").val("0,0");
                    shippingAddressId = '';
                    shippingAddressRegionId = '';
                    $shippingAddressId.val('');
                    $shippingAddressRegionId.val('');
                    $('#choiceAddr').html('<p>请选择收货地址<spa style="color:red">您没有收货地址或已有地址不在服务范围内</spa></p>');
                    return;
                }
                $('#choiceAddr').html(('<p>{0}, {1}</p><span>{2} &nbsp;{3}&nbsp;{4}</span>' +
                    '<i class="glyphicon glyphicon-menu-right"></i>')
                    .format(cacheValue.shipTo, cacheValue.phone, cacheValue.regionFullName, cacheValue.address, cacheValue.addressDetail));

                $("#latAndLng").val(cacheValue.latAndLng);
                $shippingAddressId.val(cacheValue.id);
                shippingAddressId = cacheValue.id;
                $shippingAddressRegionId.val(cacheValue.regionId);
                shippingAddressRegionId = cacheValue.regionId;

                refreshFreight(cacheValue.regionId);//刷新运费

                $("input[name$='DeliveryType'].selftake").each(function () {
                    var $this = $(this);
                    var sid = $this.attr('sid');
                    var pids = $this.attr('pids').split(',');
                    $.ajax({
                        url: existShopBranchUrl + '?shopId={0}&regionId={1}&productIds={2}'.format(sid, cacheValue.regionId, pids.join('&productIds=')),
                        context: { element: $this },
                        success: function (result) {
                            if (result.data == true) {
                                this.element.removeAttr('disabled');
                            } else if (result.data == false) {
                                this.element.attr('disabled', '');
                            }
                        }
                    });
                });
            }

            cacheValue = window.getFromLocalStorate(sbCacheKey);
            if ($.notNullOrEmpty(cacheValue) && $.notNullOrEmpty(shippingAddressRegionId)) {
                for (var shopId in cacheValue) {
                    var temp = cacheValue[shopId];
                    if (temp.regionId != shippingAddressRegionId) {
                        cacheValue = null;
                        break;
                    }

                    var radio = $('input[name="shop{0}.DeliveryType"].selftake'.format(shopId));
                    if (radio.length > 0) {
                        radio.get(0).checked = true;
                        radio.attr('sbid', temp.sbId);
                        var goodsInfo = $(radio).closest('.goods-info');
                        goodsInfo.find('.choseshopbranch').removeClass('hide').find('.content').html(temp.sbName);
                        radio.change();
                    }
                }

                CalcPrice();
            }
        } else {
            window.localStorage.removeItem(saCacheKey);
            window.localStorage.removeItem(sbCacheKey);
        }
        //window.localStorage.removeItem(tagCacheKey);

        $('#choiceAddr').click(function () {
            setTag();
            window.localStorage.removeItem(sbCacheKey);
            setReferrer();//写入当前地址
            setLeaveMmessage();//写入留言信息
            location.href = '/' + areaName + '/BranchOrder/ChooseShippingAddress?returnURL=' + encodeURIComponent(location.href);
        });

        $('a.choseshopbranch').click(function () {
            setTag();
            setReferrer();//写入当前地址
            setLeaveMmessage();//写入留言信息
            //$(this).attr('href',$(this).attr('bak-href')+'&shippingAddressId='+shippingAddressId+'&regionId='+shippingAddressRegionId);
        });

        function setTag() {
            window.saveToLocalStorage(tagCacheKey, {});
        }

        $('#userIntegralSwitch').change(function () {
            var checked = this.checked;
            if (checked) {
                isResetUseCapital = true;
            }
            var allTotal = parseFloat($("#allTotal").data("alltotal"));
            if (allTotal <= 0) {
                return false;
            }
            isintegral = checked;
            if (isintegral) {
                var _curpminput = $("#useintegral");
                var _curval = parseFloat(_curpminput.val());
                var useintegral = parseInt($("#userIntegrals").val());
                if (isNaN(useintegral)) {
                    useintegral = 0;
                }

                _curpminput.val(Math.ceil(_curpminput.data("maxmoney") * _curpminput.data("rate")));
                _curpminput.trigger("change");

                $("#integralContainer").show();
            } else {
                $("#integralContainer").hide();
            }
            CalcPrice();//切换积分兑换后要重新计算价格
        });

        $('#userCapitalSwitch').change(function () {
            iscapital = this.checked;
            if (iscapital) {
                if (hasVerifiedPayPwd) {
                    pwd = $("#PayCapitalPwd").val();
                    CanPayCapital(pwd);
                    return;
                }
                var cover = InitCover();
                $.ajax({
                    type: 'post',
                    url: '/' + areaName + '/Payment/GetPayPwd',
                    dataType: 'json',
                    data: {},
                    success: function (d) {
                        if (d.success) {
                            if ($('#payCapitalPwd').length < 1) {
                                var htmlPayPwd = "";
                                htmlPayPwd += '<div class="box1 lh24 steponeee" id="payCapitalPwd" style="display:none">';
                                htmlPayPwd += '<span class="close" aria-hidden="true"></span><form>';
                                htmlPayPwd += '<h3 class="title_txt cur">支付密码</h3>';
                                htmlPayPwd += '<div class="item"><div>';
                                htmlPayPwd += '<input type="password" placeholder="请输入支付密码" value="" id="inputCapitalPwd"  maxlength="20" class="form-control itxt fl">';
                                htmlPayPwd += '</div></div><div class="item"> <div><a id="submitCapitalPay" class="btn btn-primary">确认</a></div></div></form></div>';
                                $("body").append(htmlPayPwd);
                            }
                            cover.fadeIn();
                            $('#payCapitalPwd').show().find("#inputCapitalPwd").focus();
                        }
                        else {
                            if ($('#capitalstepone').length < 1) {
                                var htmlSetPad = "";
                                htmlSetPad += '<div class="box1 lh24 steponeee" id="capitalstepone" style="display:none">';
                                htmlSetPad += '<span class="close" aria-hidden="true"></span><form>';
                                htmlSetPad += '<h3 class="title_txt cur">请设置支付密码</h3>';
                                htmlSetPad += '<div class="item"><div class="fl">';
                                htmlSetPad += '<input type="password" placeholder="请输入支付密码" value="" id="firstCapitalPwd"  maxlength="20" class="form-control itxt fl">';
                                htmlSetPad += '</div></div><div class="item"> <div class="fl">';
                                htmlSetPad += '<input type="password" placeholder="请再次输入支付密码" value="" id="secondCapitalPwd"  maxlength="20" class="form-control itxt fl">';
                                htmlSetPad += '</div></div><div class="item"> <div class="fl"><a id="submitCapitalPwd" class="btn btn-primary">提交</a></div></div></form></div>';
                                $("body").append(htmlSetPad);
                            }
                            cover.fadeIn();
                            $('#capitalstepone').show().find("#firstCapitalPwd").focus();
                        }
                    }
                });
            } else {
                $("#capitalContainer").hide();
                CalcPrice();//切换预存款支付后要重新计算价格
            }
        });
        $("body").on("click", "#submitCapitalPay", function () {
            var pwd = $("#inputCapitalPwd").val();
            if (pwd.length == 0) {
                $.dialog.alert("请输入支付密码");
                return false;
            }
            $.post('/' + areaName + '/Payment/ValidPayPwd', { pwd: pwd }, function (result) {
                if (result.success) {
                    CanPayCapital(pwd);
                    hasVerifiedPayPwd = true;
                }
                else {
                    hasVerifiedPayPwd = false;
                    $.dialog.errorTips(result.msg);
                    return false;
                }
            });
        }).on("click", "#submitCapitalPwd", function () {
            var firstInput = $("#firstCapitalPwd");
            var secondInput = $("#secondCapitalPwd");
            var firstp = firstInput.val();
            var secondp = secondInput.val();
            if (!firstp || !secondp) {
                $.dialog.alert('密码不能为空！');
                return false;
            }
            if (firstp.length < 6 || secondp.length < 6) {
                $.dialog.alert('密码长度不能少于6位');
                return false;
            }
            if (firstp != secondp) {
                $.dialog.alert('两次密码不一致！');
                return false;
            }
            $.ajax({
                type: 'post',
                url: '/' + areaName + '/Payment/SetPayPwd',
                data: { "pwd": firstp },
                dataType: "json",
                success: function (data) {
                    var cover = InitCover();
                    cover.fadeOut();
                    if (data.success) {
                        $.dialog.succeedTips('设置成功！');
                        $('#capitalstepone').remove();
                        $("#capitalContainer").show();
                        $("#capital").focus();
                        $("#PayCapitalPwd").val(firstInput)
                        CalcPrice();//切换预存款支付后要重新计算价格
                    } else {
                        $.dialog.errorTips('设置失败请重试');
                        $('#capitalstepone').remove();
                        $('#userCapitalSwitch').click();
                    }
                }
            });
        }).on("click", "#capitalstepone .close,#payCapitalPwd .close", function () {
            $(this).parent().hide();
            var cover = InitCover();
            cover.fadeOut();
            $('#capitalstepone').remove();
            $('#payCapitalPwd').remove();
            $('#userCapitalSwitch').click();
        }).on('click', '.cover', function () {
            $('#capitalstepone .close,#payCapitalPwd .close').click();
        });


        function CanPayCapital(pwd) {
            $("#PayCapitalPwd").val(pwd);
            var cover = InitCover();
            cover.fadeOut();
            $('#payCapitalPwd').remove();
            $("#capitalContainer").show();
            $("#capital").val($("#capital").data("balance"));
            $("#capital").focus();
            CalcPrice();//切换预存款支付后要重新计算价格
        }

        $(".bill-Cart .content-bill .bill-check").eq(0).addClass("active");
        //$("#choiceAddr").click(function () {
        //    location.href = "ChooseShippingAddress?returnURL=" + encodeURIComponent(location.href);
        //})

        //支付方式选择
        $(".way-detail>a").click(function () {
            $(this).addClass("active").siblings().removeClass("active");
        });

        //发票选择
        $("#AllInvoice>div>div>span").click(function () {
            $("#AllInvoice>div>div>span").removeClass("active");
            $(this).addClass("active");
        });
        $(".content-bill>p").click(function () {
            $(".content-bill>p>span").removeClass("active");
            $("span", this).addClass("active");
        });

        var orderTag = '@ViewBag.OrderTag';
        $.ajax({
            url: '@Url.Action("IsSubmited", "BranchOrder", new { area = "mobile" })?orderTag=' + orderTag,
            cache: false,
            success: function (result) {
                if (result.data == true)
                    window.history.go(-1);//提交的订单不能退回
            }
        });
        initLeaveMsgAndBill();

        $("#capital").bind("change", function () {
            CalcPrice();
        });

        $("#useintegral").bind("change", function () {
            var _t = $(this);
            var useintegral = parseInt($("#userIntegrals").val());
            if (isNaN(useintegral)) {
                useintegral = 0;
            }
            var v = _t.val(), max = _t.data("maxmoney"), rate = _t.data("rate");
            var maxpoint = Math.floor(max * rate);

            if (maxpoint > useintegral) { maxpoint = useintegral; }
            //可抵扣金额
            var max = Math.floor((maxpoint / rate) * Math.pow(10, 2)) / Math.pow(10, 2);
            //var _dm = MoneyRound(v / rate);
            var _dm = v / rate;
            _dm = Math.floor(_dm * Math.pow(10, 2)) / Math.pow(10, 2);
            if (_dm > max) {
                _dm = max;
                _t.val(maxpoint);
            }
            $("#integralPrice").text("-￥" + _dm);
            $("#integralPerMoney").val(_dm);
            CalcPrice();
        });
    });
    function setReferrer() {
        window.localStorage.setItem("refer", window.location.href);
    }
    function setLeaveMmessage() {
        var remarkList = [];
        $('.goods-info[shopid]').each(function () {
            var shopId = $(this).attr('shopid');
            remarkList.push($('.orderRemarks#remark_' + shopId).val());
        });
        window.localStorage.setItem("remarkList", remarkList.join(','));
    }
    function initLeaveMsgAndBill() {
        var remarkList = window.localStorage.getItem("remarkList");
        //var invoiceTitle = window.localStorage.getItem("invoiceTitle");
        //var invoiceCode = window.localStorage.getItem("invoiceCode");
        //var invoiceContext = window.localStorage.getItem("invoiceContext");
        if (remarkList != null && remarkList.length > 0) {
            var remark = remarkList.split(',');
            $('.goods-info[shopid]').each(function (i) {
                var shopId = $(this).attr('shopid');
                $('.orderRemarks#remark_' + shopId).val(remark[i]);
            });
            window.localStorage.removeItem("remarkList");
        }
        $('.goods-info[shopid]').each(function () {
            var shopId = $(this).attr('shopid');
            var invoiceinfo = JSON.parse(window.localStorage.getItem("invoiceInfo" + shopId));
            if (invoiceinfo != null) {
                var $form = $(this).parent().find('div[name="formInvoice' + shopId + '"]');
                //发票类型默认
                $form.find('.dvInvoiceType span').removeClass('active');
                $form.find('.dvInvoiceType span').each(function () {
                    if (parseInt($(this).attr('data-id')) == invoiceinfo.InvoiceType) {
                        $(this).addClass("active");
                    }
                });
                switch (invoiceinfo.InvoiceType) {
                    case 0:
                        break;
                    case 1:
                        $form.find('.elInvoice').hide();
                        $form.find('.dvInvoiceTitle').show();
                        $form.find('.vatInvoice').hide();
                        $form.find('.invoiceDay').hide();
                        break;
                    case 2:
                        $form.find('.elInvoice').show();
                        $form.find('.dvInvoiceTitle').show();
                        $form.find('.vatInvoice').hide();
                        $form.find('.invoiceDay').hide();
                        break;
                    case 3:
                        $form.find('.elInvoice').hide();
                        $form.find('.dvInvoiceTitle').hide();
                        $form.find('.vatInvoice').show();
                        $form.find('.invoiceDay').show();
                        break;
                }
                //发票抬头默认
                $form.find('.dvInvoiceRise span').removeClass('active');
                if (invoiceinfo.Name == "个人") {
                    $form.find('.dvInvoiceRise span').eq(0).addClass('active');
                    $(this).parent().parent().find('.dvInvoincPepole').show();
                    $(this).parent().parent().find('.dvInvoincCompany').hide();
                }
                else {
                    $form.find('.dvInvoiceRise span').eq(1).addClass('active');
                    $(this).parent().parent().find('.dvInvoincCompany').show();
                    $(this).parent().parent().find('.dvInvoincPepole').hide();
                    $form.find('input[name="invoicename"]').val(invoiceinfo.Name);
                    $form.find('input[name="invoicecode"]').val(invoiceinfo.Code);
                }

                //发票类容默认
                $form.find('.dvInvoiceContext span').removeClass('active');
                $form.find('.dvInvoiceContext span').each(function () {
                    if ($(this).text() == invoiceinfo.InvoiceContext) {
                        $(this).addClass("active");
                    }
                });
                //电子发票默认收票人信息
                if (invoiceinfo.InvoiceType == 2) {
                    $form.find('input[name="cellphone"]').val(invoiceinfo.CellPhone);
                    $form.find('input[name="email"]').val(invoiceinfo.Email);
                }
                //增值税默认
                if (invoiceinfo.InvoiceType == 3) {
                    $form.find('input[name="companyname"]').val(invoiceinfo.Name);
                    $form.find('input[name="companyno"]').val(invoiceinfo.Code);
                    $form.find('input[name="registeraddress"]').val(invoiceinfo.RegisterAddress);
                    $form.find('input[name="registerphone"]').val(invoiceinfo.RegisterPhone);
                    $form.find('input[name="bankname"]').val(invoiceinfo.BankName);
                    $form.find('input[name="bankno"]').val(invoiceinfo.BankNo);
                    $form.find('input[name="vatrealname"]').val(invoiceinfo.RealName);
                    $form.find('input[name="vatcellphone"]').val(invoiceinfo.CellPhone);
                    $form.find('input[name="RegionID"]').val(invoiceinfo.RegionID);
                    $form.find('input[name="vataddress"]').val(invoiceinfo.Address);
                }
                var rate = parseFloat($form.find('.dvInvoiceType span.active').attr('data-rate'));
                var typename = $form.find('.dvInvoiceType span.active').html();
                var s = '<span style="' + (rate <= 0 ? "display:none" : "") + '">(税率<span class="taxprice red" shopid="' + shopId + '">' + rate + '%</span>)</span> ' + typename + '(' + invoiceinfo.Name + ')';
                $('.bill-title' + shopId).html(s);
                CalcPrice();
            } else {
                var s = '不需要发票';
                $('.bill-title' + shopId).html(s);
                CalcPrice();
            }
            window.localStorage.removeItem("invoiceInfo" + shopId);
        });
        //if (invoiceTitle != null && invoiceTitle != '') {
        //    $(".bill a").text(invoiceTitle);
        //    $(".bill #invoicecode").text(invoiceCode);
        //    $(".bill-Cart .content-bill .bill-check").removeClass("active").eq(invoiceContext - 1).addClass("active");
        //    window.localStorage.removeItem("invoiceTitle");
        //    window.localStorage.removeItem("invoiceCode");
        //    window.localStorage.removeItem("invoiceContext");
        //}
    }

    function onChooseCoupon(couponBaseId, baseType, obj, shopid) {
        var oldCouponId = $(obj).parent().next().val();
        if (couponBaseId != oldCouponId) {
            $(obj).parent().next().val(couponBaseId);
            $(obj).parent().next().attr("data-type", baseType);
            changeConditionReload();
        }
    }

    function changeConditionReload() {
        var couponIds = "";
        $('input[name="couponIds"]').each(function (i, e) {
            var type = $(this).attr("data-type");
            couponIds = couponIds + $(e).val() + '_' + type + '_' + $(this).data("shopid") + ',';
        })
        if (couponIds != '') {
            couponIds = couponIds.substring(0, couponIds.length - 1);
        }
        var url = location.href;
        if (url.toLowerCase().indexOf("couponids") < 0) {
            var splitText = "?";
            var _tmparr = url.split(splitText);
            console.log(_tmparr);
            url = _tmparr[0];
            url += "?couponids=";
            if (_tmparr.length > 1) {
                url += "&" + _tmparr[1];
            }
        }
        console.log(url);
        url = url.replace(/([\?&]couponids=)[^\?&]*/, "$1" + couponIds);
        location.href = url;
    }


    function onChoosePlatCoupon(couponBaseId, baseType, obj, shopid) {

        var oldCouponId = $(obj).parent().next().val();
        if (couponBaseId != oldCouponId) {
            $(obj).parent().next().val(couponBaseId);
            $(obj).parent().next().attr("data-type", baseType);
            changePlatConditionReload(shopid);
        }
        else {
            $(obj).parent().next().val(0);
            $(obj).parent().next().attr("data-type", 99);
            changePlatConditionReload(shopid);
        }
    }


    function changePlatConditionReload(shopid) {
        var couponIds = "";
        $('input[name="platCouponIds"]').each(function (i, e) {
            var type = $(this).attr("data-type");
            couponIds = couponIds + $(e).val() + '_' + type + '_' + shopid + ',';
        })
        if (couponIds != '') {
            couponIds = couponIds.substring(0, couponIds.length - 1);
        }
        var url = location.href;
        if (url.toLowerCase().indexOf("platcouponid") < 0) {
            var splitText = "?";
            var _tmparr = url.split(splitText);
            console.log(_tmparr);
            url = _tmparr[0];
            url += "?platcouponid=";
            if (_tmparr.length > 1) {
                url += "&" + _tmparr[1];
            }
        }
        url = url.replace(/([\?&]platcouponid=)[^\?&]*/, "$1" + couponIds);

        location.href = url;
    }

    </script>
